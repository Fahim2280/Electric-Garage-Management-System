@model EGMS.DTOs.ElectricBillDTO

@{
    ViewData["Title"] = "Create Electric Bill";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Create New Electric Bill
                    </h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="electricBillForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger alert alert-danger" role="alert"></div>

                        <!-- Customer Selection Row -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Customer_ID" class="form-label fw-bold">Customer *</label>
                                    <select asp-for="Customer_ID" class="form-select" id="customerSelect">
                                        <option value="">-- Select Customer --</option>
                                        @foreach (var customer in ViewBag.Customers as List<EGMS.Models.Customer>)
                                        {
                                            <option value="@customer.C_ID">@customer.Name</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Customer_ID" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Date" class="form-label fw-bold">Bill Date *</label>
                                    <input asp-for="Date" class="form-control" type="date" />
                                    <span asp-validation-for="Date" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Summary Display -->
                        <div id="customerSummary" class="alert alert-info" style="display: none;">
                            <h6><i class="fas fa-info-circle me-2"></i>Customer Summary</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Customer:</strong> <span id="summaryCustomerName"></span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Last Meter Reading:</strong> <span id="summaryLastReading"></span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Previous Dues:</strong> ৳<span id="summaryPreviousDues"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Input Fields Row -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label asp-for="Current_Unit" class="form-label fw-bold">Current Unit Reading *</label>
                                    <input asp-for="Current_Unit" class="form-control" type="number" step="0.01" id="currentUnit" placeholder="Enter current meter reading" />
                                    <span asp-validation-for="Current_Unit" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label asp-for="Rent_Bill" class="form-label fw-bold">Rent Bill *</label>
                                    <input asp-for="Rent_Bill" class="form-control" type="number" step="0.01" id="rentBill" placeholder="Enter rent amount" />
                                    <span asp-validation-for="Rent_Bill" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label asp-for="Clear_money" class="form-label fw-bold">Payment Amount *</label>
                                    <input asp-for="Clear_money" class="form-control" type="number" step="0.01" id="clearMoney" placeholder="Enter payment amount" />
                                    <span asp-validation-for="Clear_money" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Fields for Calculated Values -->
                        <input asp-for="Previous_unit" type="hidden" />
                        <input asp-for="Total_Unit" type="hidden" />
                        <input asp-for="Electric_bill" type="hidden" />
                        <input asp-for="Previous_duos" type="hidden" />
                        <input asp-for="Total_bill" type="hidden" />
                        <input asp-for="Present_dues" type="hidden" />

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success btn-lg me-2" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>
                                        Create Bill
                                    </button>
                                    <a class="btn btn-secondary btn-lg" asp-action="Index">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Back to List
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $(document).ready(function () {
            // Customer selection change event
            $('#customerSelect').change(function () {
                var customerId = $(this).val();
                if (customerId) {
                    loadCustomerSummary(customerId);
                } else {
                    $('#customerSummary').hide();
                }
            });

            // Load customer summary
            function loadCustomerSummary(customerId) {
                $.get('/ElectricBill/GetCustomerSummary', { customerId: customerId })
                    .done(function (response) {
                        if (response.success) {
                            $('#summaryCustomerName').text(response.data.customerName);
                            $('#summaryLastReading').text(response.data.lastMeterReading);
                            $('#summaryPreviousDues').text(response.data.previousDues.toFixed(2));
                            $('#customerSummary').show();
                        } else {
                            alert('Error loading customer summary: ' + response.message);
                        }
                    })
                    .fail(function () {
                        alert('Error loading customer summary.');
                    });
            }

            // Form validation
            $('#electricBillForm').submit(function (e) {
            const lastReading = parseFloat($('#summaryLastReading').text());
            const currentReading = parseFloat($('#currentUnit').val());
            const rent = parseFloat($('#rentBill').val());
            const payment = parseFloat($('#clearMoney').val());
            const previousDues = parseFloat($('#summaryPreviousDues').text());

            if (isNaN(currentReading) || isNaN(rent) || isNaN(payment)) {
                alert("Please enter valid numeric values for unit, rent, and payment.");
                return false;
            }

            const totalUnit = currentReading - lastReading;
            const electricBill = totalUnit * 15;
            const totalBill = previousDues + electricBill + rent;
            const presentDues = totalBill - payment;

            $('input[name="Previous_unit"]').val(lastReading);
            $('input[name="Total_Unit"]').val(totalUnit);
            $('input[name="Electric_bill"]').val(electricBill);
            $('input[name="Previous_dues"]').val(previousDues);
            $('input[name="Total_bill"]').val(totalBill);
            $('input[name="Present_dues"]').val(presentDues);

            // Proceed with submission
            return true;
        });

        });
    </script>
}

@section Styles {
    <style>
        .form-label {
            color: #495057;
            font-weight: 600;
        }

        .card {
            border: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
        }

        .alert-info {
            background-color: #e7f3ff;
            border-color: #b3d9ff;
            color: #0c5460;
        }

        .text-danger {
            font-size: 0.875rem;
        }

        .fas {
            width: 16px;
            text-align: center;
        }
    </style>
}